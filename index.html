<!DOCTYPE html>
<html>
  <head>
    <title>Botanico Internet Check</title>
    <meta
      name="viewport"
      content="width=device-width, height=device-height, initial-scale=1.0, minimum-scale=1.0"
    />

    <link
      rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/milligram/1.3.0/milligram.css"
    />
    <link rel="stylesheet" href="/css/style.css" />
    <style type="text/css">
      .tright {
        text-align: right;
      }
      .center {
        text-align: center;
      }
    </style>
    <script type="text/javascript">
      var ws;
      var wsUri = 'ws:';
      var loc = window.location;
      console.log(loc);
      if (loc.protocol === 'https:') {
        wsUri = 'wss:';
      }
      wsUri += 'cubo-lab.mybluemix.net/ws/pico-ping';
      let cnt = 10;
      let startTs = new Date();
      setInterval(function () {
        document.getElementById('timer').innerHTML =
          'PrÃ³xima mensagem em: ' + cnt + ' segundos';
        cnt--;
      }, 1000);

      document.addEventListener('DOMContentLoaded', () => {
        //onload="wsConnect();"
        wsConnect();
      });

      function wsConnect() {
        console.log('connect', wsUri);
        ws = new WebSocket(wsUri);

        //var line = "";    // either uncomment this for a building list of messages
        ws.onmessage = function (msg) {
          var line = ''; // or uncomment this to overwrite the existing message
          // parse the incoming message as a JSON object

          // var sp1 = (new Date(parseInt(msg.data))).toLocaleString([], {timeZone: 'America/Sao_Paulo'});
          // var sp2 = (new Date(parseInt(msg.data))).toLocaleString([], {timeZone: 'UTC'});

          console.log(msg);

          data = JSON.parse(msg.data);

          if (data.value == 100) {
            value = 'ðŸŸ¢ Online';
          } else {
            value = 'ðŸ”´ Offline';
          }

          line = value + ' | Visto em ' + data.lastSeenTime;
          cnt = 10;

          // replace the messages div with the new "line"
          document.getElementById('messages').innerHTML = line;
          //ws.send(JSON.stringify({data:data}));

          nowTs = new Date();
        };
        ws.onopen = function () {
          // update the status div with the connection status
          document.getElementById('status').innerHTML = 'ðŸ”µ servidor conectado';
          //ws.send("Open for data");
          console.log('connected');
        };
        ws.onclose = function () {
          // update the status div with the connection status
          document.getElementById('status').innerHTML =
            'ðŸ”´ servidor desconectado';
          // in case of lost connection tries to reconnect every 3 secs
          setTimeout(wsConnect, 3000);
        };
      }

      function doit(m) {
        if (ws) {
          ws.send(m);
        }
      }
    </script>
  </head>
  <body onunload="ws.disconnect();">
    <div class="container center">
      <h1>Botanico Internet Check</h1>
      <div class="logo"></div>
      <section class="status">
        <header>Status</header>
        <div id="messages" class="center">Aguardando menssagem...</div>
        <div id="timer"></div>
      </section>
      <section class="graph">
        <header>MÃ©tricas</header>
        <img
          src="https://docs.google.com/spreadsheets/d/e/2PACX-1vSIxey6krnl99PojVXz7dhkyoma8cGCCo6SgEUKODiGwn3exiJQPylRKZ5wKnpzS9nm0TxOfhiryJG1/pubchart?oid=24811961&amp;format=image"
        />
      </section>
      <section class="footer">
        <header>Status do Servidor</header>
        <div id="status" class="tright">ðŸ”´ servidor desconectado</div>
      </section>
    </div>

    <!--<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>-->
  </body>
</html>
